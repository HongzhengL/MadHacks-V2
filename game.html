<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>The Badger Budget: Planning Edition</title>
        <style>
            :root {
                --bg-color: #f4f5f7;
                --header-bg: #ffffff;
                --primary-red: #c5050c;
                --money-green: #2ecc71;
                --money-blue: #3498db;
                --money-yellow: #f1c40f;
                --money-gray: #95a5a6;
                --credit-purple: #9b59b6;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background-color: var(--bg-color);
                margin: 0;
                padding: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- UTILS --- */
            .hidden {
                display: none !important;
            }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .modal-box {
                background: white;
                padding: 2rem;
                border-radius: 12px;
                width: 90%;
                max-width: 600px;
                text-align: center;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            }
            .selection-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin: 20px 0;
            }
            .select-card {
                border: 2px solid #ddd;
                padding: 15px;
                border-radius: 8px;
                cursor: pointer;
                transition: 0.2s;
            }
            .select-card:hover {
                border-color: var(--primary-red);
                background: #fff5f5;
            }

            /* --- HEADER --- */
            header {
                background: var(--header-bg);
                padding: 10px 20px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .stat-badge {
                padding: 8px 16px;
                border-radius: 6px;
                font-weight: bold;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .bg-light {
                background: #f8f9fa;
                border: 1px solid #ddd;
            }
            .bg-green-light {
                background: #e8f5e9;
                color: #27ae60;
                border: 1px solid #c8e6c9;
            }
            .btn-primary {
                background: var(--primary-red);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
            }

            /* --- WALLET --- */
            .wallet-row {
                background: white;
                padding: 10px 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            .bill {
                width: 60px;
                height: 35px;
                border-radius: 4px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-weight: bold;
                color: white;
                cursor: grab;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                user-select: none;
            }
            .bill:active {
                cursor: grabbing;
                transform: scale(0.95);
            }
            .bill-100 {
                background: var(--money-green);
            }
            .bill-50 {
                background: var(--money-blue);
            }
            .bill-10 {
                background: var(--money-yellow);
                color: #444;
            }
            .bill-1 {
                background: var(--money-gray);
            }
            .card-credit {
                background: var(--credit-purple);
                width: 80px;
            }

            /* --- BOARD --- */
            .board {
                display: flex;
                flex: 1;
                padding: 10px;
                gap: 10px;
                overflow-x: auto;
            }
            .column {
                flex: 1;
                min-width: 220px;
                background: white;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                border-top: 5px solid #ccc;
            }

            .col-fixed {
                border-top-color: #f1c40f;
                background: #fffde7;
            }
            .col-var {
                border-top-color: #3498db;
                background: #e3f2fd;
            }
            .col-goal {
                border-top-color: #e67e22;
                background: #fff3e0;
            }
            .col-event {
                border-top-color: #2ecc71;
                background: #e8f5e9;
            }
            .col-opp {
                border-top-color: #9b59b6;
                background: #f3e5f5;
            }

            .col-header {
                padding: 10px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                font-size: 0.85rem;
                color: #555;
            }
            .col-content {
                padding: 10px;
                flex: 1;
                overflow-y: auto;
            }

            /* --- GAME CARD --- */
            .game-card {
                background: white;
                border: 1px solid #ddd;
                border-left: 4px solid #ccc;
                border-radius: 6px;
                padding: 10px;
                margin-bottom: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                position: relative;
            }
            .game-card.fixed {
                border-left-color: #f1c40f;
            }
            .game-card.var {
                border-left-color: #3498db;
            }
            .game-card.goal {
                border-left-color: #e67e22;
            }
            .game-card.event {
                border-left-color: #2ecc71;
            }
            .game-card.opp {
                border-left-color: #9b59b6;
            }

            .game-card.paid-full {
                border-left-color: #2ecc71;
                background: #f0fff4;
            }

            .card-top {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            .card-title {
                font-weight: bold;
                font-size: 0.9rem;
            }

            .drop-zone {
                border: 2px dashed #ccc;
                border-radius: 4px;
                padding: 15px 5px;
                text-align: center;
                font-size: 0.8rem;
                color: #aaa;
                margin-top: 5px;
                transition: background 0.2s;
            }
            .drop-zone.hover {
                background: #e8f5e9;
                border-color: #2ecc71;
                color: #2ecc71;
            }

            /* --- MINI BILLS (UNDO UI) --- */
            .payment-stack {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                margin-top: 8px;
                min-height: 20px;
            }
            .mini-bill {
                font-size: 0.7rem;
                padding: 2px 6px;
                border-radius: 3px;
                color: white;
                cursor: pointer;
                user-select: none;
                position: relative;
            }
            .mini-bill:hover::after {
                content: "Ã—";
                position: absolute;
                top: -5px;
                right: -5px;
                background: red;
                color: white;
                border-radius: 50%;
                width: 12px;
                height: 12px;
                font-size: 10px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* Progress Bar */
            .card-progress {
                height: 4px;
                background: #eee;
                margin-top: 5px;
                border-radius: 2px;
                overflow: hidden;
            }
            .card-progress-bar {
                height: 100%;
                background: #2ecc71;
                width: 0%;
                transition: width 0.3s;
            }

            .toast {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="setup-modal" class="modal-overlay">
            <div class="modal-box" id="setup-step-1">
                <h2>Welcome to Madison! ðŸ¦¡</h2>
                <p>Select your income level:</p>
                <div class="selection-grid" id="diff-options"></div>
            </div>
            <div class="modal-box hidden" id="setup-step-2">
                <h2>Choose Housing</h2>
                <p>Rent is paid every 2 weeks.</p>
                <div class="selection-grid" id="housing-options"></div>
            </div>
        </div>

        <header>
            <div style="display: flex; gap: 10px; align-items: center">
                <h3 style="margin: 0; color: var(--primary-red)">
                    Badger Budget
                </h3>
                <div class="stat-badge bg-light">
                    Week <span id="ui-round">1</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center">
                <div class="stat-badge bg-green-light">
                    Balance:
                    <span id="ui-cash" style="margin-left: 5px">$0</span>
                </div>
                <div class="stat-badge bg-light">
                    Credit:
                    <span id="ui-debt" style="margin-left: 5px">$0</span>
                </div>
                <div
                    class="stat-badge"
                    style="background: #e3f2fd; color: #1565c0">
                    QoL: <span id="ui-qol" style="margin-left: 5px">50</span>
                </div>
                <button class="btn-primary" onclick="nextRound()">
                    Finish Round
                </button>
            </div>
        </header>

        <div class="wallet-row">
            <span style="font-weight: bold; font-size: 0.9rem; color: #555"
                >Drag to Pay:</span
            >
            <div
                class="bill bill-100"
                draggable="true"
                ondragstart="drag(event)"
                data-val="100"
                data-type="cash">
                $100
            </div>
            <div
                class="bill bill-50"
                draggable="true"
                ondragstart="drag(event)"
                data-val="50"
                data-type="cash">
                $50
            </div>
            <div
                class="bill bill-10"
                draggable="true"
                ondragstart="drag(event)"
                data-val="10"
                data-type="cash">
                $10
            </div>
            <div
                class="bill bill-1"
                draggable="true"
                ondragstart="drag(event)"
                data-val="1"
                data-type="cash">
                $1
            </div>
            <div style="width: 1px; height: 20px; background: #ddd"></div>
            <div
                class="bill card-credit"
                draggable="true"
                ondragstart="drag(event)"
                data-val="ALL"
                data-type="credit">
                ðŸ’³ Credit
            </div>
            <span style="font-size: 0.8rem; color: #888; margin-left: auto"
                >Tip: Click small bills on cards to undo.</span
            >
        </div>

        <div class="board">
            <div class="column col-fixed">
                <div class="col-header">
                    FIXED <span id="count-fixed">(0)</span>
                </div>
                <div class="col-content" id="col-fixed-content"></div>
            </div>
            <div class="column col-var">
                <div class="col-header">
                    VARIABLE <span id="count-var">(0)</span>
                </div>
                <div class="col-content" id="col-var-content"></div>
            </div>
            <div class="column col-goal">
                <div class="col-header">
                    GOAL <span id="count-goal">(0)</span>
                </div>
                <div class="col-content" id="col-goal-content"></div>
            </div>
            <div class="column col-event">
                <div class="col-header">
                    EVENT <span id="count-event">(0)</span>
                </div>
                <div class="col-content" id="col-event-content"></div>
            </div>
            <div class="column col-opp">
                <div class="col-header">
                    OPPORTUNITY <span id="count-opp">(0)</span>
                </div>
                <div class="col-content" id="col-opp-content"></div>
            </div>
        </div>

        <div id="toast" class="toast">Msg</div>

        <script>
            const CONFIG = {
                difficulties: [
                    { id: "hard", label: "Entry Level", pay: 1440 },
                    { id: "med", label: "Mid-Career", pay: 2160 },
                    { id: "easy", label: "Senior", pay: 2880 },
                ],
                housing: [
                    { id: "shared", label: "Shared Room", cost: 350 },
                    { id: "apt", label: "1BR Apt", cost: 800 },
                    { id: "lux", label: "Luxury Loft", cost: 1100 },
                ],
            };

            let state = {
                round: 1,
                cash: 0,
                debt: 0,
                qol: 50,
                job: null,
                home: null,
                cards: [],
            };

            // --- INIT ---
            function init() {
                const dContainer = document.getElementById("diff-options");
                CONFIG.difficulties.forEach((d) => {
                    dContainer.innerHTML += `<div class="select-card" onclick="setDiff('${d.id}')"><h3>${d.label}</h3><p>$${d.pay}</p></div>`;
                });
            }

            function setDiff(id) {
                state.job = CONFIG.difficulties.find((d) => d.id === id);
                document.getElementById("setup-step-1").classList.add("hidden");
                document
                    .getElementById("setup-step-2")
                    .classList.remove("hidden");

                const hContainer = document.getElementById("housing-options");
                CONFIG.housing.forEach((h) => {
                    hContainer.innerHTML += `<div class="select-card" onclick="setHousing('${h.id}')"><h3>${h.label}</h3><p>$${h.cost}</p></div>`;
                });
            }

            function setHousing(id) {
                state.home = CONFIG.housing.find((h) => h.id === id);
                document.getElementById("setup-modal").classList.add("hidden");
                state.cash = 500;
                startRound();
            }

            // --- ROUND LOGIC ---
            function startRound() {
                state.cash += state.job.pay;
                showToast(`Payday! +$${state.job.pay}`);
                generateCards();
                renderAll();
            }

            function generateCards() {
                state.cards = [];
                addCard("fixed", "Rent", state.home.cost);
                if (state.round % 2 === 0) addCard("fixed", "Utilities", 120);
                addCard("var", "Groceries", 200);
                addCard("var", "Fun / Ent", 100);
                addCard("goal", "Emergency Fund", 100, true); // true = optional

                if (Math.random() > 0.7)
                    addCard("event", "Speeding Ticket", 150);
            }

            function addCard(type, title, amount, optional = false) {
                state.cards.push({
                    id: Date.now() + Math.random(),
                    type,
                    title,
                    amount,
                    payments: [], // NEW: Track specific bills dropped here
                    optional,
                });
            }

            // --- DRAG & DROP & UNDO ---
            function drag(ev) {
                ev.dataTransfer.setData("val", ev.target.dataset.val);
                ev.dataTransfer.setData("type", ev.target.dataset.type);
            }

            function allowDrop(ev) {
                ev.preventDefault();
                ev.currentTarget.classList.add("hover");
            }
            function leaveDrop(ev) {
                ev.currentTarget.classList.remove("hover");
            }

            function drop(ev, cardId) {
                ev.preventDefault();
                ev.currentTarget.classList.remove("hover");

                let card = state.cards.find((c) => c.id == cardId);
                let valStr = ev.dataTransfer.getData("val");
                let type = ev.dataTransfer.getData("type");

                // Calculate current total paid
                let currentPaid = card.payments.reduce(
                    (sum, p) => sum + p.amount,
                    0,
                );
                let remaining = card.amount - currentPaid;

                if (remaining <= 0 && !card.optional) {
                    showToast("Card already paid!");
                    return;
                }

                let amount = 0;

                if (type === "credit") {
                    if (card.type === "goal") {
                        showToast("Can't save with credit!");
                        return;
                    }
                    amount = remaining; // Credit pays full remainder
                    state.debt += amount;
                } else {
                    amount = parseInt(valStr);
                    if (state.cash < amount) {
                        showToast("Not enough cash!");
                        return;
                    }
                    state.cash -= amount;
                }

                // ADD PAYMENT TO STACK (The Undo Hook)
                card.payments.push({
                    id: Date.now(),
                    amount: amount,
                    type: type,
                });

                renderAll();
            }

            // NEW: Undo Function
            function removePayment(cardId, paymentId) {
                let card = state.cards.find((c) => c.id == cardId);
                let payIdx = card.payments.findIndex((p) => p.id == paymentId);

                if (payIdx === -1) return;

                let payment = card.payments[payIdx];

                // Refund
                if (payment.type === "credit") {
                    state.debt -= payment.amount;
                } else {
                    state.cash += payment.amount;
                }

                // Remove from stack
                card.payments.splice(payIdx, 1);

                renderAll();
            }

            // --- RENDER ---
            function renderAll() {
                updateHeader();
                ["fixed", "var", "goal", "event", "opp"].forEach((t) => {
                    document.getElementById(`col-${t}-content`).innerHTML = "";
                    document.getElementById(`count-${t}`).innerText = `(${
                        state.cards.filter((c) => c.type === t).length
                    })`;
                });

                state.cards.forEach((card) => {
                    let paid = card.payments.reduce(
                        (sum, p) => sum + p.amount,
                        0,
                    );
                    let progress = Math.min(100, (paid / card.amount) * 100);
                    let isDone = paid >= card.amount;

                    // Generate Mini-Bills HTML
                    let stackHtml = card.payments
                        .map((p) => {
                            let colorClass = "";
                            if (p.type === "credit") colorClass = "card-credit";
                            else if (p.amount === 100) colorClass = "bill-100";
                            else if (p.amount === 50) colorClass = "bill-50";
                            else if (p.amount === 10) colorClass = "bill-10";
                            else colorClass = "bill-1";

                            return `<div class="mini-bill ${colorClass}" onclick="removePayment(${
                                card.id
                            }, ${p.id})">
                        ${p.type === "credit" ? "Cred" : "$" + p.amount}
                    </div>`;
                        })
                        .join("");

                    let html = `
            <div class="game-card ${card.type} ${isDone ? "paid-full" : ""}">
                <div class="card-top">
                    <span class="card-title">${card.title}</span>
                    <span style="font-weight:bold">$${card.amount}</span>
                </div>
                
                ${
                    !isDone
                        ? `
                <div class="drop-zone" ondrop="drop(event, ${card.id})" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    Drop Here
                </div>`
                        : ""
                }

                <div class="payment-stack">
                    ${stackHtml}
                </div>

                <div class="card-progress">
                    <div class="card-progress-bar" style="width: ${progress}%"></div>
                </div>
                <div style="text-align:right; font-size:0.8rem; margin-top:4px; color:#666;">
                    ${isDone ? "Paid!" : `$${card.amount - paid} left`}
                </div>
            </div>
        `;
                    document.getElementById(
                        `col-${card.type}-content`,
                    ).innerHTML += html;
                });
            }

            function updateHeader() {
                document.getElementById("ui-round").innerText = state.round;
                document.getElementById("ui-cash").innerText = `$${state.cash}`;
                document.getElementById("ui-debt").innerText = `$${state.debt}`;
                document.getElementById("ui-qol").innerText = state.qol;
            }

            function nextRound() {
                // Check unpaid fixed
                let unpaidFixed = state.cards.filter(
                    (c) =>
                        c.type === "fixed" &&
                        c.payments.reduce((s, p) => s + p.amount, 0) < c.amount,
                );

                if (unpaidFixed.length > 0) {
                    if (
                        !confirm(
                            "You have unpaid Fixed Expenses! Proceeding will add them to debt + penalty.",
                        )
                    )
                        return;
                    unpaidFixed.forEach((c) => {
                        let paid = c.payments.reduce((s, p) => s + p.amount, 0);
                        state.debt += c.amount - paid + 50;
                        state.qol -= 5;
                    });
                }

                state.round += 2;
                if (state.round > 26) {
                    alert("Game Over! QoL: " + state.qol);
                    location.reload();
                } else startRound();
            }

            function showToast(msg) {
                const t = document.getElementById("toast");
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => (t.style.opacity = 0), 2000);
            }

            init();
        </script>
    </body>
</html>
